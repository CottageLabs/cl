
<style>
	html, body {
		background-color:white;
	}
	h1 {
		font-family:"Times New Roman";
	}
</style>

<link rel="stylesheet" href="http://compliance.cottagelabs.com/static/css/service.css">


<div class="navbar navbar-fixed-top" style="background-color:white;border-bottom:4px solid grey;">
	<div class="container-fluid" style="max-width:1200px;">
		<div class="navbar-header">
			<a class="navbar-brand" href="/"><img src="http://www.wellcome.ac.uk/stellent/groups/corporatesite/@policy_communications/documents/web_document/WTP051585.jpg" width="150"><img></a>
			<ul class="nav navbar-nav">
				<li><a href="/" style="font-size:1em;">Upload</a></li>
				<li><a href="http://compliance.cottagelabs.com/docs" style="font-size:1em;">Documentation</a></li>
			</ul>
		</div>
	</div>
</div>

<div class="container-fluid" id="uploader" style="max-width:1200px;margin-top:100px;margin-bottom:200px;">
	<div class="row">
    <div class="col-md-offset-3 col-md-6" style="padding:0px 20px 0px 0px;">
    	<h1 style="text-align:center;">Upload a CSV</h1>
    	<p>You can export a CSV from Excel, then upload it here.  See the <a href="http://compliance.cottagelabs.com/docs">documentation</a> for more details.</p>
			<form class="contact-form">
				<div class="well" style="border-top:5px solid #0e8293;">
					<input type="file" name="upload" id="upload" class="form-control">
					<input class="form-control" id="email" name="email" placeholder="Email (required)" type="email" value="">
				</div>
        <div class="well" style="display:none;" id="review">
          <p>
            Thank you. Your file appears to have <span id="count">X</span> record rows in it, containing 
						<span id="dois">X</span> DOIs, <span id="pmcids">X</span> PMC IDs, <span id="pmids">X</span> PubMed IDs, 
						and <span id="titles">X</span> titles.
						Is this correct?
            If so, please submit for processing now:
          </p>
        </div> 
        <input type="submit" class="submit form-control" id="lanternmulti" name="submit" value="Submit" style="background-color:grey;color:white;font-size:1.4em;height:50px;">
        <input type="submit" class="submit form-control disabled" id="submitting" name="submitting" value="Submitting, please wait" style="display:none;background-color:grey;color:white;font-size:1.4em;height:50px;">
      	<div id="errormsg" style="display:none;" class="alert alert-warning"></div>
			</form>
    </div>
  </div>
</div>

<div class="container-fluid" id="poller" style="max-width:1200px;margin-top:100px;margin-bottom:200px;display:none;">
	<div class="row">
    <div class="col-md-offset-3 col-md-6" id="pollinfo" style="padding:0px 20px 0px 0px;">
		</div>
	</div>
</div>

<div style="width:100%;border-top:1px solid #000000"></div>

<div class="container-fluid" style="max-width:1200px;">
	<div class="row">
		<div class="col-md-12" style="padding-bottom:100px">
			<p class="pull-right">&copy; Cottage Labs 2016</p>
		</div>
	</div>
</div>


<script>
jQuery(document).ready(function() {
	$('#footer').hide();
	
  var file;
	var filename = '';
  var results = [];
	var dois = 0;
	var pmcids = 0;
	var pmids = 0;
	var titles = 0;
  var review = function() {
		//console.log(results);
    console.log(results.length);
    console.log(dois);
    console.log(pmcids);
    console.log(pmids);
    console.log(titles);
    //$('#count').html(results.length);
    //$('#dois').html(dois);
    //$('#pmcids').html(pmcids);
    //$('#pmids').html(pmids);
    //$('#titles').html(titles);
		//$('#review').append(JSON.stringify(results));
    //$('#review').show();
  }
  var transform = function(split) {
		results = [];
		dois = 0;
		pmcids = 0;
		pmids = 0;
		titles = 0;
		//console.log(file);
		if (split === undefined) split = ',';
    var wrap = '';
		// could try to change the below so that other wraps could be used - look for starting character of each row, for example
    if ( file[0] === '"') wrap = '"'; 
    if ( file[0] === "'") wrap = "'";
		console.log('Using wrap char ' + wrap);
		// could add a check here for places where the wrap markers appear around something that is not a comma
		// to identify where different split characters are being used
    file = file.replace(/\r\n/g,'\n'); // switch MS line breaks to unix
    file = file.replace(/\n{2,}/g,'\n'); // get rid of any blank lines
    file = file.replace(/\n*$/g,''); // get rid of any newlines and the end of the file
		if (file[file.length-1] !== '\n') file = file + '\n'; // add a newline at end of file for matching convenience
		if (wrap.length > 0) {
			var re = new RegExp('\n' + split + '+\n',"g"); // remove lines that contain only empty unwrapped values
			file = file.replace(re,'\n');
			var rre = new RegExp(wrap + split + '+\n',"g"); // remove empty unwrapped values from lines
			file = file.replace(rre,'\n');
		}
		if (file[file.length-1] === '\n') file = file.substring(0,file.length-1); // remove the convenience newline from end of file
		var lines = file.split(wrap + "\n" + wrap);
    var headers = lines[0].split(wrap + split + wrap);
		if (wrap.length > 0 && headers[0].substring(0,wrap.length) === wrap ) headers[0] = headers[0].substring(1);
		for ( var h = 0; h < headers.length; h++ ) {
			headers[h] = headers[h].replace(/(^\s*)|(\s*$)/g,''); // strip whitespace leading and ending header names
			//headers[h] = headers[h].toLowerCase(); // lowercase the headers
			//headers[h] = headers[h].replace(/[^a-z0-9]/g,''); // remove any chars that are not a-z or 0-9
			//headers[h] = headers[h].replace(/ /g,'_'); // replace whitespace with underscores
			// could add more header cleaning here
		}
    for (var i = 1; i < lines.length; i++) {
			if (wrap.length > 0 && i === 1 && lines[i].substring(0,wrap.length) === wrap ) lines[i] = lines[i].substring(1);
			if (wrap.length > 0 && i === lines.length-1 && lines[i].substring(lines[i].length-wrap.length) === wrap ) lines[i] = lines[i].substring(0,lines[i].length-1);
  	  var obj = {};
	    var currentline = lines[i].split(wrap + split + wrap);
      if ( currentline.length > 0) {
				var lengths = 0;
        for (var j = 0; j < headers.length; j++) {
					if (currentline[j]) {
						obj[headers[j]] = currentline[j];
						lengths = currentline[j].length;
					} else {
						obj[headers[j]] = '';
					}
        }
				if (obj.doi || obj.DOI) dois += 1;
				if (obj.pmcid || obj.PMCID) pmcids += 1;
				if (obj.pmid || obj.PMID) pmids += 1;
				if (obj.title || obj['Article title']) titles += 1;
    	  if (lengths) results.push(obj);
      }
    }
    review();
  }
  var prep = function(e) {
		var f = e.target.files[0];
		filename = f.name;
		var reader = new FileReader();
		reader.onload = (function(theFile) {
			return function(e) {
				file = e.target.result;
				transform();
			};
		})(f);
		reader.readAsText(f);
  }
  $('input[type=file]').on('change', prep);

	var error = function(data) {
		$('#lanternmulti').show();
		$('#submitting').hide();
		$('#errormsg').html('<p>Sorry, there has been an error with your submission. Please try again.</p><p>If you continue go receive an error, please contact us@cottagelabs.com with the following error information:</p><p>' + JSON.stringify(data) + '</p>').show();
    console.log(data);
  }

	var done = false;
	var poll, hash;
	var polling = function(data) {
		console.log('poll returned');
		console.log(data);
		$('#uploader').hide();
		$('#poller').show();
		if ( !data.data ) data.data = 0;
		var status = '<p>Your job is ' + data.data + '% complete.</p>';
		status += '<p><a href="http://dev.api.cottagelabs.com/service/lantern/' + hash + '/results?format=csv" class="btn btn-default btn-block">Download your results</a></p>';
		//status += '<p style="text-align:center;padding-top:10px;"><a href="http://dev.api.cottagelabs.com/service/lantern/' + hash + '/original" style="font-weight:normal;">or download your original spreadsheet</a></p>';
		if (data.data !== 100) setTimeout(poll,10000);
		$('#pollinfo').html(status);
	}
	poll = function(hash) {
		if (hash === undefined) {
			hash = window.location.hash.replace('#','');
		}
		if ( hash ) {
			$.ajax({
				url: 'http://dev.api.cottagelabs.com/service/lantern/' + hash + '/progress',
				method: 'GET',
				success: polling,
				error: error
			});		
		}
	}
	
	if (window.location.hash) {
		$('#uploader').hide();
		hash = window.location.hash.replace('#','');
		console.log(hash);
		poll(hash);
	}
	
  var success = function(data) {
		$('#lanternmulti').show();
		$('#submitting').hide();
    console.log(data);
		try {
			window.history.pushState("", "poll", '#' + data.data.job);
		} catch (err) {}
		hash = data.data.job;
		poll(data.data.job);
  }
  var submit = function(e) {
		$('#errormsg').html("").hide();
		e.preventDefault();
		var email = $('#email').val();
		if (!email) {
			$('#errormsg').html('You must provide an email address in order to submit a job. Please do so, and try again.').show();
		} else {
			$('#lanternmulti').hide();
			$('#submitting').show();
			var payload = {list:results,name:filename,email:email};
			$.ajax({
				url: 'http://dev.api.cottagelabs.com/service/lantern',
				method: 'POST',
				data: JSON.stringify(payload),
				dataType: 'JSON',
				contentType: "application/json; charset=utf-8",
				success: success,
				error: error
			});
		}
  }
  $('#lanternmulti').bind('click',submit);
  
});
</script>
