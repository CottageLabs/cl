{% extends "base.html" %}

{% block content %}

<script>
jQuery(document).ready(function() {

    // do things once page is fully built
    var pageready = function() {
        dofacetviews();
    }

    // do the nested embed of dynamic divs
    var embed = function(data) {
        var content = data['content'];
        this.into.html('');
        this.into.append(content);
        this.into.attr('id',data['id']);
        this.into.addClass('expanded');
        var children = [];
        this.into.find('.dynamic').each(function() {
            children.push($(this).attr('data-source').replace('.json',''));
            var src = $(this).attr('data-source').replace('.json','') + '.json';
            $.ajax({"url": src, "success": embed, "into": $(this)});
        });
        if ( $('.dynamic').not('.expanded').length == 0) {
            pageready(this);
        };
    };        

    // replace any dynamic content divs with the actual content
    $('.dynamic').each(function() {
        var src = $(this).attr('data-source').replace('.json','') + '.json';
        $.ajax({"url": src, "success": embed, "into": $(this)});
    });

    // put any facetviews into any facetview divs
    var facetview_opts = {
        "search_url": "/query/pages/_search?",
        "datatype": "json",
        "display_images": false,
        "pushstate":false
    };
    var cl_feature_titles = function(event) {
        var settings = {
            maxFontPixels: 60,
            minFontPixels: 20,
            innerTag: 'a',
            widthOnly: false,
            callback: null,
            complete: null,
            explicitWidth: null,
            explicitHeight: null
        };
        $('.cl_feature_box').textfill(settings);
        settings.minFontPixels = 16;
        $('.cl_feature_text').textfill(settings);
        $('.cl_feature_title:odd').css("color","#ed1c24");
        $('.row-fluid .feature_span:nth-child(4n+1)').css("margin-left",0);
    };
    facetview_opts.post_search_callback = cl_feature_titles;
    var dofacetviews = function() {
        $('.facetview').each(function() {
            var opts = jQuery.extend(true, {}, facetview_opts); // clone the options
            for ( var style in options.facetview_displays ) {
                $(this).hasClass('facetview-' + style) ? opts = $.extend(opts, options.facetview_displays[style] ) : "";
            };
            $(this).hasClass('facetview-slider') ? opts.pager_slider = true : "";
            $(this).hasClass('facetview-descending') ? opts['sort'] = [{"created_date.exact":{"order":"desc"}}] : "";
            $(this).hasClass('facetview-ascending') ? opts['sort'] = [{"created_date.exact":{"order":"asc"}}] : "";
            if ( $(this).hasClass('facetview-searchable') ) {
                opts.embedded_search = true;
            } else {
                opts.embedded_search = false;
            };
            $(this).attr('data-search') ? opts.q = $(this).attr('data-search') : "";
            $(this).attr('data-size') ? opts.paging.size = $(this).attr('data-size') : "";
            $(this).attr('data-from') ? opts.paging.from = $(this).attr('data-from') : "";
            $(this).facetview(opts);
        });
    };
});
</script>

{{ content|safe }}

{% endblock %}





