{% extends "/base.html" %}

{% block content %}

<script type="text/javascript">
jQuery(document).ready(function() {

    // give a filter onto all the pages
    var filter = function(event) {
        event ? event.preventDefault() : false;
        var val = $(this).val();
        if ( val.length ) {
            $('.filterit').each(function() {
                if ( $(this).val().indexOf(val) >= 0 || $(this).siblings().val().indexOf(val) >= 0 ) {
                    $(this).parents('.recordset').show();
                } else {
                    $(this).parents('.recordset').hide();
                }
            });
        } else {
            $('.recordset').show();
        }
    };
    $('#filter').bind('keyup',filter);
    
    // show bulk tagging options
    var tagbulk = function(event) {
        event ? event.preventDefault() : false;
        //$('.tagsbypage').toggle();
        $('.tagsdirect').toggle();
        gettags();
    };
    $('#tagbulk').bind('click',tagbulk);
    
    var tagupdate = function(event) {
        event ? event.preventDefault() : false;
        if ( $(this).hasClass('tagswitch') ) {
            var currtag = $(this).html();
        } else {
            var currtag = $(this).siblings().first().html();
        }
        if ( $(this).hasClass('tagswitch') ) {
            var replacetag = prompt('On selected records, replace tag ' + currtag + ' with: ');
        } else if ( $(this).hasClass('tagremove') ) {
            var removetag = confirm('Are you sure you want to delete this tag from all selected records?');
        };
        $('.identifier').each(function() {
            if ( $(this).attr('checked') ) {
                var rid = $(this).attr('id');
                var tagbox = $(this).parent().siblings().find('.'+rid);
                var tags = tagbox.select2("val");
                if ( replacetag ) {
                    tags.push(replacetag);
                    var idx = tags.indexOf(currtag);
                    idx >= 0 ? tags.splice(idx,1) : false;
                    tagbox.select2("val",tags);
                } else if ( removetag ) {
                    var idx = tags.indexOf(currtag);
                    idx >= 0 ? tags.splice(idx,1) : false;
                    tagbox.select2("val",tags);
                } else if ( replacetag === undefined && removetag === undefined ) {
                    if ( tags.indexOf(currtag) < 0 ) {
                        tags.push(currtag);
                        tagbox.select2("val",tags);
                    }
                }
            };
        });
    };
    var showtags = function(data) {
        $('#alltags').html('');
        for ( var tag in data ) {
            var tagbtn = '<div class="btn-group" style="margin:0 10px 10px 0; display:inline; float:left;">';
            tagbtn += '<button class="btn tagswitch">' + data[tag] + '<i style="margin-left:5px;" class="icon-refresh"></i></button>';
            tagbtn += '<button class="btn tagremove"><i class="icon-minus"></i></button>';
            tagbtn += '<button class="btn tagadd"><i class="icon-plus"></i></button>';
            tagbtn += '</div>';
            $('#alltags').append(tagbtn);
        }
        $('.tagswitch').bind('click',tagupdate);
        $('.tagremove').bind('click',tagupdate);
        $('.tagadd').bind('click',tagupdate);
    };
    var gettags = function(event) {
        event ? event.preventDefault() : false;
        $.ajax({
            'type': 'GET',
            'url': '/stream/record/tags',
            'success': showtags
        });
    };

    // enable tagselect on the tags box
    var tagify = function(data) {
        $('.page_tags').select2({
            "tags":data,
            "tokenSeparators":[","],
            "width":"element",
        });
        $('#page_tags_bulk').select2({
            "tags":data,
            "tokenSeparators":[","],
            "width":"element",
        });
        $('.page_tags').css({
            "margin-bottom":"8px",
            "width":"100%"
        });
        $('.select2-choices').css({
            "-webkit-border-radius":"3px",
            "-moz-border-radius":"3px",
            "border-radius":"3px",
            "border":"1px solid #ccc"
        });            
    };
    $.ajax({
        "url": "/stream/record/tags?size=1000",
        "success": function(data) {
            tagify(data);
        }
    });    
    
    var selectall = function(event) {
        event ? event.preventDefault() : false;
        var checked = $(this).attr('checked');
        var count = 0;
        $('.identifier:visible').each(function() {
            checked ? $(this).attr('checked','checked') : $(this).attr('checked',false);
            count += 1;
        });
        alert(count);
    };
    $('.selectall').bind('change',selectall);
});
</script>

<form action="" method="POST">
<div class="row-fluid">
    <input class="tagsbypage" type="text" id="filter" placeholder="filter by text query" style="margin-right:10px;" />
    <a id="tagbulk" class="btn" href="#" style="margin:-10px 10px 0 0;">do bulk tagging <b class="caret"></b></a>
    <input class="tagsbypage btn btn-info" type="submit" name="submit" value="save all changes" style="margin:-9px 0 0 0;" />
</div>

<div class="row-fluid tagsdirect" style="display:none;">
    <div class="span12 alert">
        <div id="tagnew" style="margin-bottom:10px;">
            <p>Replace / remove / add tags from your selected records. Be sure to select some records first. To add a new tag, add it to one record first then save; then it can be selected below and added to multiple records. Remember to save changes once you are done.</p>
        </div>
        <div id="alltags">
        </div>
    </div>
</div>

<table style="margin-top:10px;" class="tagsbypage table table-striped table-bordered">
<tr>
<td style="width:50px;"><strong>Select<br><input type="checkbox" class="selectall"> (all)</strong></td>
<td><strong>Title & URL</strong></td>
<td><strong>Excerpt</strong></td>
<td><strong>Tags</strong></td>
<td><strong>Accessible</strong></td>
<td><strong style="color:red;">Delete</strong></td>
</tr>
{% for record in records %}
<tr class="recordset">
<td>
    <input name="id_{{ record['id'] }}" type="hidden" />
    <input name="selected_{{ record['id'] }}" id="{{ record['id'] }}" class="identifier" type="checkbox" /></td>
<td><input name="title_{{ record['id'] }}" class="filterit" style="width:200px;" type="text" value="{{ record['title'] }}" /><br>
    <input name="url_{{ record['id'] }}" style="width:200px;" type="text" value="{{ record['url'] }}" /></td>
<td><textarea name="excerpt_{{ record['id'] }}" style="width:200px;">{{ record['excerpt'] }}</textarea></td>
<td><input name="tags_{{ record['id'] }}" class="page_tags {{ record['id'] }}" style="width:150px;" type="text" value="{{ ','.join(record['tags']) }}" /></td>
<td><input name="accessible_{{ record['id'] }}" type="checkbox" {% if record['accessible'] %}checked{% endif %}/></td>
<td><input name="delete_{{ record['id'] }}" type="checkbox" style="outline:1px solid red;" /></td>
</tr>
{% endfor %}
</table>
<div class="row-fluid">
    <input class="tagsbypage btn btn-info" type="submit" name="submit" value="save all changes" style="float:right;" />
    <a class="tagsbypage btn" style="float:right; margin-right:10px;" href="">cancel changes and reload</a></div>
</form>

{% endblock %}
