
<script type="text/javascript">
// track mouse locations so they can be used for popovers
var mouseX;
var mouseY;
$(document).mousemove( function(e) {
   mouseX = e.pageX; 
   mouseY = e.pageY;
});  


// define the network graph as per mbostocks structure for reusable charts
// also use a lot from the example at http://flowingdata.com/2012/08/02/how-to-make-an-interactive-network-visualization/
// some of this I don't understand yet... a new way of writing d3 vis to me

var Network, RadialPlacement, root;

root = typeof exports !== "undefined" && exports !== null ? exports : this;

// use this from the example at flowing data to do radial placement - works perfectly well, no need to rewrite
// skip down to Network to see the main code
RadialPlacement = function() {
  var center, current, increment, place, placement, radialLocation, radius, setKeys, start, values;
  values = d3.map();
  increment = 20;
  radius = 200;
  center = {
    "x": 0,
    "y": 0
  };
  start = -120;
  current = start;
  radialLocation = function(center, angle, radius) {
    var x, y;
    x = center.x + radius * Math.cos(angle * Math.PI / 180);
    y = center.y + radius * Math.sin(angle * Math.PI / 180);
    return {
      "x": x,
      "y": y
    };
  };
  placement = function(key) {
    var value;
    value = values.get(key);
    if (!values.has(key)) {
      value = place(key);
    }
    return value;
  };

  /*var addtitles = function(keys,locations) {
    var locations = []
    var text = svgContainer.selectAll("text")
                        .data(locations)
                        .enter()
                        .append("text");
    var textLabels = text
                        .attr("x", function(d) { return d.cx; })
                        .attr("y", function(d) { return d.cy; })
                        .text( function (d) { return d.ckey; })
                        .attr("font-family", "sans-serif")
                        .attr("font-size", "20px")
                        .attr("fill", "#ccc");    
  };*/
  
  place = function(key) {
    var value;
    value = radialLocation(center, current, radius);
    values.set(key, value);
    current += increment;
    return value;
  };
  setKeys = function(keys) {
    var firstCircleCount, firstCircleKeys, secondCircleKeys;
    values = d3.map();
    firstCircleCount = 360 / increment;
    if (keys.length < firstCircleCount) {
      increment = 360 / keys.length;
    }
    firstCircleKeys = keys.slice(0, firstCircleCount);
    firstCircleKeys.forEach(function(k) {
      return place(k);
    });
    secondCircleKeys = keys.slice(firstCircleCount);
    radius = radius + radius / 1.8;
    increment = 360 / secondCircleKeys.length;
    return secondCircleKeys.forEach(function(k) {
      return place(k);
    });
  };
  placement.keys = function(_) {
    if (!arguments.length) {
      return d3.keys(values);
    }
    setKeys(_);
    return placement;
  };
  placement.center = function(_) {
    if (!arguments.length) {
      return center;
    }
    center = _;
    return placement;
  };
  placement.radius = function(_) {
    if (!arguments.length) {
      return radius;
    }
    radius = _;
    return placement;
  };
  placement.start = function(_) {
    if (!arguments.length) {
      return start;
    }
    start = _;
    current = start;
    return placement;
  };
  placement.increment = function(_) {
    if (!arguments.length) {
      return increment;
    }
    increment = _;
    return placement;
  };
  return placement;
};

// the main thing that builds the vis
Network = function() {
  var allData, charge, curLinksData, curNodesData, filterLinks, force, forceTick, groupCenters, height, hideDetails, layout, link, linkedByIndex, linksG, mapNodes, moveToRadialLayout, neighboring, network, node, nodeColors, nodeCounts, nodesG, radialTick, setLayout, setupData, showDetails, sortedrtypes, strokeFor, update, updateCenters, updateLinks, updateNodes, width;
  width = 800;
  height = 500;
  allData = [];
  curLinksData = [];
  curNodesData = [];
  linkedByIndex = {};
  nodesG = null;
  linksG = null;
  node = null;
  link = null;
  layout = "force";
  groupCenters = null;
  force = d3.layout.force();
  nodeColors = d3.scale.category20();
  charge = function(node) {
    return -Math.pow(node.radius, 2.0) / 2;
  };
  network = function(selection, data) {
    var vis;
    allData = setupData(data);
    vis = d3.select(selection).append("svg").attr("width", width).attr("height", height);
    linksG = vis.append("g").attr("id", "links");
    nodesG = vis.append("g").attr("id", "nodes");
    force.size([width, height]);
    setLayout("force");
    return update();
  };
  update = function() {
    var rtypes;
    curNodesData = allData.nodes;
    curLinksData = filterLinks(allData.links, curNodesData);
    if (layout === "radial") {
      rtypes = sortedrtypes(curNodesData, curLinksData);
      updateCenters(rtypes);
    }
    force.nodes(curNodesData);
    updateNodes();
    if (layout === "force") {
      force.links(curLinksData);
      updateLinks();
    } else {
      force.links([]);
      if (link) {
        link.data([]).exit().remove();
        link = null;
      }
    }
    return force.start();
  };
  network.toggleLayout = function(newLayout) {
    force.stop();
    setLayout(newLayout);
    return update();
  };
  network.updateData = function(newData) {
    allData = setupData(newData);
    link.remove();
    node.remove();
    return update();
  };
  setupData = function(data) {
    var circleRadius, countExtent, nodesMap;
    countExtent = d3.extent(data.nodes, function(d) {
      return d.budget;
    });
    circleRadius = d3.scale.sqrt().range([5, 12]).domain(countExtent);
    data.nodes.forEach(function(n) {
      var randomnumber;
      n.x = randomnumber = Math.floor(Math.random() * width);
      n.y = randomnumber = Math.floor(Math.random() * height);
      return n.radius = circleRadius(n.budget);
    });
    nodesMap = mapNodes(data.nodes);
    data.links.forEach(function(l) {
      l.source = nodesMap.get(l.source);
      l.target = nodesMap.get(l.target);
      return linkedByIndex["" + l.source.id + "," + l.target.id] = 1;
    });
    return data;
  };
  mapNodes = function(nodes) {
    var nodesMap;
    nodesMap = d3.map();
    nodes.forEach(function(n) {
      return nodesMap.set(n.id, n);
    });
    return nodesMap;
  };
  nodeCounts = function(nodes, attr) {
    var counts;
    counts = {};
    nodes.forEach(function(d) {
      var _name, _ref;
      if ((_ref = counts[_name = d[attr]]) == null) {
        counts[_name] = 0;
      }
      return counts[d[attr]] += 1;
    });
    return counts;
  };
  neighboring = function(a, b) {
    return linkedByIndex[a.id + "," + b.id] || linkedByIndex[b.id + "," + a.id];
  };
  sortedrtypes = function(nodes, links) {
    var rtypes, counts;
    rtypes = [];
    counts = nodeCounts(nodes, "rtype");
    rtypes = d3.entries(counts).sort(function(a, b) {
      return b.value - a.value;
    });
    rtypes = rtypes.map(function(v) {
      return v.key;
    });
    return rtypes;
  };
  updateCenters = function(rtypes) {
    if (layout === "radial") {
      return groupCenters = RadialPlacement().center({
        "x": width / 2,
        "y": height / 2 - 100
      }).radius(300).increment(18).keys(rtypes);
    }
  };
  filterLinks = function(allLinks, curNodes) {
    curNodes = mapNodes(curNodes);
    return allLinks.filter(function(l) {
      return curNodes.get(l.source.id) && curNodes.get(l.target.id);
    });
  };
  updateNodes = function() {
    node = nodesG.selectAll("circle.node").data(curNodesData, function(d) {
      return d.id;
    });
    node.enter().append("circle").attr("class", "node").attr("cx", function(d) {
      return d.x;
    }).attr("cy", function(d) {
      return d.y;
    }).attr("r", function(d) {
      return d.radius;
    }).style("fill", function(d) {
      return nodeColors(d.rtype);
    }).style("stroke", function(d) {
      return strokeFor(d);
    }).style("stroke-width", 1.0);
    node.call(force.drag);
    node.on("mouseover", showDetails).on("mouseout", hideDetails).on("click",storeDetails);
    return node.exit().remove();
  };
  updateLinks = function() {
    link = linksG.selectAll("line.link").data(curLinksData, function(d) {
      return "" + d.source.id + "_" + d.target.id;
    });
    link.enter().append("line").attr("class", "link").attr("stroke", "#ddd").attr("stroke-opacity", 0.8).attr("x1", function(d) {
      return d.source.x;
    }).attr("y1", function(d) {
      return d.source.y;
    }).attr("x2", function(d) {
      return d.target.x;
    }).attr("y2", function(d) {
      return d.target.y;
    });
    return link.exit().remove();
  };
  setLayout = function(newLayout) {
    layout = newLayout;
    if (layout === "force") {
      return force.on("tick", forceTick).charge(-200).linkDistance(50);
    } else if (layout === "radial") {
      return force.on("tick", radialTick).charge(charge);
    }
  };
  forceTick = function(e) {
    node.attr("cx", function(d) {
      return d.x;
    }).attr("cy", function(d) {
      return d.y;
    });
    return link.attr("x1", function(d) {
      return d.source.x;
    }).attr("y1", function(d) {
      return d.source.y;
    }).attr("x2", function(d) {
      return d.target.x;
    }).attr("y2", function(d) {
      return d.target.y;
    });
  };
  radialTick = function(e) {
    node.each(moveToRadialLayout(e.alpha));
    node.attr("cx", function(d) {
      return d.x;
    }).attr("cy", function(d) {
      return d.y;
    });
    if (e.alpha < 0.03) {
      force.stop();
      return updateLinks();
    }
  };
  moveToRadialLayout = function(alpha) {
    var k;
    k = alpha * 0.1;
    return function(d) {
      var centerNode;
      centerNode = groupCenters(d.rtype);
      d.x += (centerNode.x - d.x) * k;
      return d.y += (centerNode.y - d.y) * k;
    };
  };
  strokeFor = function(d) {
    return d3.rgb(nodeColors(d.rtype)).darker().toString();
  };
  
  // show / hide the popover information when hovering on a bubble
  var clearthem = function(event) {
    event.preventDefault();
    $('#infodisplay').html('');
  }
  showDetails = function(d, i) {
    var content;
    if ( !$('#clearsnippets').length ) {
        $('#infodisplay').prepend('<div id="clearsnippets"><span id="clickmsg" class="close" style="float:left;font-size:11px;">click bubble to stick</span><a id="clearthem" class="close" style="float:right;padding-right:15px;" href="#">x</a></div>');
        $('#clearthem').bind('click',clearthem);
    }
    $('#clickmsg').show();
    $('#infodisplay').scrollTop(0);
    content = '<div style="clear:both;float:left;background:white;border:2px solid ' + nodeColors(d.rtype) + ';-webkit-border-radius:5px;-moz-border-radius:5px;border-radius:5px;width:157px;margin-top:2px;padding-left:3px;" id="' + d.id + '" class="mytooltip">';
    if ( d.rtype === 'projects' ) {
        content += '<strong>' + d.rtype + ' - ' + d.name + '</strong><br>';
        content += 'A ' + d.status + ' project led by ' + d.lead + '. Budget £' + d.budget + ' ex. VAT. End date ' + d.dateto + '.';
    } else if ( d.rtype === 'commitments' ) {
        content += '<strong>' + d.rtype + ' - ' + d.name + '</strong><br>';
        content += d.name + ' commits ' + d.time + '% time between ' + d.datefrom + ' and ' + d.dateto + ' to ' + d.project + ' for ' + d.share + '% share.';    
    } else if ( d.rtype === 'financials' ) {
        content += '<strong>financial event</strong><br>';
        content += 'A ' + d.status + ' ' + d.type + ' of ' + d.cost + ' ex VAT on project ' + d.project + '.';
        d.datepaid ? content += ' Paid on ' + d.datepaid + '.' : content += ' Due on ' + d.duedate + '.';
    } else if ( d.rtype === 'people' ) {
        content += '<strong>CL person - ' + d.name + '</strong><br>';
        if ( d.senior === 'yes' ) {
            content += 'senior partner.<br>';
        } else if ( d.partner === 'yes' ) {
            content += 'partner.<br>';
        }
    } else if ( d.rtype === 'contacts' ) {
        content += '<strong>Contact - ' + d.name + '</strong><br>';
    } else if ( d.rtype === 'contractors' ) {
        content += '<strong>Contractor - ' + d.name + '</strong><br>';
    }
    if ( d.rtype == 'people' ) {
    } else {
        var rt = d.rtype;
        if ( rt.substring(rt.length-1,rt.length) == 's' ) { rt = rt.substring(0,d.rtype.length-1); }
        content += ' <a class="interestshowmore" data-type="' + d.rtype + '" href="/admin/' + rt + '/' + d.id + '">more&raquo;</a><br></div>';
    }
    $('#clearsnippets').after(content);
    var showmore = function(event) {
        event ? event.preventDefault() : false;
        bubblegetthenewitem(event,source=$(this).attr('href'),which=$(this).attr('data-type'));
    }
    $('.interestshowmore').unbind('click',showmore);
    $('.interestshowmore').bind('click',showmore);
    if (link) {
      link.attr("stroke", function(l) {
        if (l.source === d || l.target === d) {
          d.rtype == 'contacts' ? $('#' + d.id).append(l.rtype + ' on ' + l.target.id + '.<br>') : false;
          if ( d.rtype == 'people' ) {
            if ( l.rtype == 'commitment' ) {
              $('#' + d.id).append(l.rtype + ' on ' + l.target.project + '.<br>');
            } else {
              $('#' + d.id).append(l.rtype + ' on ' + l.target.id + '.<br>');
            }
          }
          return "#555";
        } else {
          return "#ddd";
        }
      }).attr("stroke-opacity", function(l) {
        if (l.source === d || l.target === d) {
          return 1.0;
        } else {
          return 0.5;
        }
      });
    }
    node.style("stroke", function(n) {
      if (neighboring(d, n)) {
        return "#555";
      } else {
        return strokeFor(n);
      }
    }).style("stroke-width", function(n) {
      if (neighboring(d, n)) {
        return 2.0;
      } else {
        return 1.0;
      }
    });
    return d3.select(this).style("stroke", "black").style("stroke-width", 2.0);
  };
  hideDetails = function(d, i) {
    $('#clickmsg').hide();
    $('.mytooltip').each(function() {
        !$(this).hasClass('sticky') ? $(this).remove() : false;
    });
    !$('.mytooltip').length ? $('#clearsnippets').remove() : false;
    node.style("stroke", function(n) {
      return strokeFor(n);
    }).style("stroke-width", function(n) {
      return 1.0;
    });
    if (link) {
      return link.attr("stroke", "#ddd").attr("stroke-opacity", 0.8);
    }
  };
  var storeDetails = function(d, i) {
    $('#' + d.id).addClass('sticky');
  }
  
  return network;
};

// run it
$(function() {
    // for triggering queries to get updated datasets
    var runupdates = function(data) {
        myNetwork.updateData(data);
    }
    var getnewdata = function() {
        var url = '/admin/everything?q=*' + $('#filterquery').val().replace('*','') + '*&datefrom=' + $('#datefrom').val() + '&dateto=' + $('#dateto').val();
        //var url = '/admin/everything?';
        url += '&project=' + $('#filterproject').val() + '&person=' + $('#filterperson').val();
        url +=  '&contact=' + $('#filtercontact').val() + '&contractor=' + $('#filtercontractor').val();
        var ignore = ''
        $('.ignore').each(function() {
            if ( !$(this).attr('checked') ) {
                ignore ? ignore += ',' : false;
                ignore += $(this).val();
            }
        });
        ignore ? url += '&ignore=' + ignore : false;
        $('#ignoreisolated').attr('href') === 'y' ? url += '&ignoreisolated=y' : false;
        $.ajax(url).done(runupdates);
    }
    $('.bubblefilter').bind('change',getnewdata);
    $('input.bubblefilter').bind('keyup',getnewdata);
    var ignoreisolated = function(event) {
        event.preventDefault();
        $(this).attr('href') === '' ? $(this).attr('href','y') : $(this).attr('href','');
        $(this).attr('href') === '' ? $(this).html($(this).html().replace('show','ignore')) : $(this).html($(this).html().replace('ignore','show'));
        getnewdata();
    }
    $('#ignoreisolated').bind('click',ignoreisolated);
    var changelayout = function(event) {
        event.preventDefault();
        var newLayout = $(this).attr('href');
        newLayout === 'force' ? $(this).attr('href','radial') : $(this).attr('href','force');
        newLayout === 'force' ? $(this).html($(this).html().replace('web','grouped')) : $(this).html($(this).html().replace('grouped','web'));
        return myNetwork.toggleLayout(newLayout);
    }
    $('#changelayout').bind('click',changelayout);

    // now start the bubbles
    var myNetwork;
    myNetwork = Network();
    var json = {{ everything|safe }};
    return myNetwork("#vis", json);
});



</script>

<div class="row-fluid" style="margin-top:20px;">
    <div class="span2">
        <div>
            <a style="width:200px;margin-bottom:5px;" id="changelayout" class="btn" href="radial">change to grouped display</a>
        </div>
        <div>
            <a style="width:200px;margin-bottom:5px;" id="ignoreisolated" class="btn" href="">ignore isolated nodes</a>
        </div>
        <div>
            <select class="bubblefilter" id="filterproject">
                <option></option>
                {% for item in dropdowns["projects"] %}
                <option>{{ item }}</option>
                {% endfor %}
            </select>
        </div>
        <!--
        <div style="margin-top:-5px;margin-bottom:5px;">
            <input class="bubblefilter" type="checkbox" value="current" disabled /> only current projects<br>
            <input class="bubblefilter" type="checkbox" value="external" disabled /> only external projects
        </div>
        -->
        <div>
            <select class="bubblefilter" id="filterperson">
                <option></option>
                {% for item in dropdowns["clpeople"] %}
                <option>{{ item }}</option>
                {% endfor %}
            </select>
        </div>
        <!--
        <div style="margin-top:-5px;margin-bottom:5px;">
            <input class="bubblefilter" type="checkbox" value="partner" disabled /> only partners<br>
            <input class="bubblefilter" type="checkbox" value="senior" disabled /> only senior partners
        </div>
        -->
        <div>
            <select class="bubblefilter" id="filtercontact">
                <option></option>
                {% for item in dropdowns["contacts"] %}
                <option value="{{ item[0] }}">{{ item[1] }}{% if item[2] %} - {{ item[2] }}{% endif %}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <select class="bubblefilter" id="filtercontractor">
                <option></option>
                {% for item in dropdowns["contractors"] %}
                <option value="{{ item[0] }}">{{ item[1] }}{% if item[2] %} - {{ item[2] }}{% endif %}</option>
                {% endfor %}
            </select>
        </div>
        <div style="width:220px;">
            <input class="bubblefilter" type="text" id="filterquery" placeholder="filter by query string" /><br>
            <input class="bubblefilter datepicker" style="width:98px;" type="text" id="datefrom" placeholder="or from date" /> 
            <input class="bubblefilter datepicker" style="width:98px;" type="text" id="dateto" placeholder="and/or to date" />
        </div>
        <div style="width:220px;">
            <div style="float:left;width:112px;">
                <input class="bubblefilter ignore" type="checkbox" value="financials" checked /> financials<br>
                <input class="bubblefilter ignore" type="checkbox" value="contacts" checked /> contacts<br>
                <input class="bubblefilter ignore" type="checkbox" value="contractors" checked /> contractors
            </div>
            <div style="float:left;">
                <input class="bubblefilter ignore" type="checkbox" value="projects" checked /> projects<br>
                <input class="bubblefilter ignore" type="checkbox" value="commitments" checked /> commitments <br>
                <input class="bubblefilter ignore" type="checkbox" value="people" checked /> people
            </div>
        </div>
    </div>
    <div class="span8">
        <div id="vis"></div>
    </div>
    <div class="span2">
        <div id="infodisplay" style="width:180px;height:500px;overflow:auto;"></div>
    </div>

</div>
